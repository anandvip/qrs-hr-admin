<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRS Attendance Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --background: #f1f5f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--background);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        h1 {
            text-align: center;
            color: #1e293b;
            margin-bottom: 2rem;
        }

        .auth-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .controls {
            max-width: 500px;
            margin: 0 auto 2rem;
        }

        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            margin: 0 0.5rem;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }

        th, td {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            text-align: left;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            color: white;
            text-align: center;
            display: none;
        }

        .loading {
            text-align: center;
            color: #64748b;
            padding: 2rem;
            display: none;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login View -->
        <div id="loginView" class="view active">
            <h1>QRS Attendance Dashboard</h1>
            <div class="auth-section">
                <button onclick="login()" class="btn-primary">Login with Google</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="view">
            <div class="auth-section">
                <button onclick="logout()" class="btn-secondary">Logout</button>
            </div>

            <div id="dashboardAlert" class="alert"></div>
            <div id="loading" class="loading">Loading...</div>

            <div class="controls">
                <select id="employeeSelect">
                    <option value="">Select Employee</option>
                </select>
            </div>

            <div id="statsSection" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCheckins">0</div>
                        <div class="stat-label">Total Check-ins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="attendanceRate">0%</div>
                        <div class="stat-label">Attendance Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgCheckInTime">--:--</div>
                        <div class="stat-label">Average Check-in Time</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Check-in Time</th>
                            <th>Check-out Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            query,
            where,
            getDocs,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';

        // Initialize Firebase
        const app = initializeApp({
            apiKey: "AIzaSyBvPYd8ksZLlfLWz2TUxk43ee9hZkMvxVU",
            authDomain: "qrs-sales.firebaseapp.com",
            projectId: "qrs-sales",
            storageBucket: "qrs-sales.firebasestorage.app",
            messagingSenderId: "839598049982",
            appId: "1:839598049982:web:776f6a67e95c04f266ecef"
        });

        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // UI Functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            const alert = document.getElementById('dashboardAlert');
            alert.style.backgroundColor = type === 'success' ? '#16a34a' : '#dc2626';
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
        }

        // Load Employees
        async function loadEmployees() {
            try {
                showLoading(true);
                const employeesRef = collection(db, 'employees');
                const q = query(employeesRef, orderBy('fullName'));
                const snapshot = await getDocs(q);

                const select = document.getElementById('employeeSelect');
                select.innerHTML = '<option value="">Select Employee</option>';

                snapshot.forEach(doc => {
                    const employee = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${employee.fullName} (${employee.empId})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading employees:', error);
                showAlert('Failed to load employees', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load Attendance
        async function loadAttendance(employeeId) {
            try {
                showLoading(true);
                document.getElementById('statsSection').style.display = 'none';

                const attendanceRef = collection(db, 'attendance');
                const q = query(
                    attendanceRef,
                    where('employeeId', '==', employeeId),
                    orderBy('timestamp', 'desc')
                );
                const snapshot = await getDocs(q);

                let records = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    records.push({
                        ...data,
                        id: doc.id,
                        timestamp: data.timestamp.toDate()
                    });
                });

                updateStats(records);
                updateTable(records);
                document.getElementById('statsSection').style.display = 'block';

            } catch (error) {
                console.error('Error loading attendance:', error);
                showAlert('Failed to load attendance records', 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateStats(records) {
            const checkIns = records.filter(r => r.type === 'check-in');
            
            // Total Check-ins
            document.getElementById('totalCheckins').textContent = checkIns.length;

            // Attendance Rate
            const workingDays = getWorkingDays();
            const rate = (checkIns.length / workingDays * 100).toFixed(1);
            document.getElementById('attendanceRate').textContent = rate + '%';

            // Average Check-in Time
            if (checkIns.length > 0) {
                const avgTime = checkIns.reduce((acc, curr) => {
                    return acc + curr.timestamp.getHours() * 60 + curr.timestamp.getMinutes();
                }, 0) / checkIns.length;

                const hours = Math.floor(avgTime / 60);
                const minutes = Math.floor(avgTime % 60);
                document.getElementById('avgCheckInTime').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
        }

        function updateTable(records) {
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '';

            let checkInRecord = null;
            records.forEach(record => {
                if (record.type === 'check-in') {
                    checkInRecord = record;
                } else if (record.type === 'check-out' && checkInRecord) {
                    const duration = (record.timestamp - checkInRecord.timestamp) / (1000 * 60 * 60);
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${checkInRecord.timestamp.toLocaleDateString()}</td>
                        <td>${checkInRecord.timestamp.toLocaleTimeString()}</td>
                        <td>${record.timestamp.toLocaleTimeString()}</td>
                        <td>${duration.toFixed(2)} hours</td>
                        <td>${checkInRecord.timestamp.getHours() >= 9 ? 'Late' : 'On Time'}</td>
                    `;
                    
                    checkInRecord = null;
                }
            });
        }

        function getWorkingDays() {
            const today = new Date();
            const start = new Date(today.getFullYear(), today.getMonth(), 1);
            let days = 0;

            while (start <= today) {
                if (start.getDay() !== 0) days++; // Skip Sundays
                start.setDate(start.getDate() + 1);
            }

            return days;
        }

        // Event Listeners
        document.getElementById('employeeSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                loadAttendance(e.target.value);
            } else {
                document.getElementById('statsSection').style.display = 'none';
            }
        });

        // Auth Functions
        window.login = () => signInWithPopup(auth, googleProvider);
        window.logout = () => signOut(auth);

        // Auth State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                switchView('dashboard');
                loadEmployees();
            } else {
                switchView('login');
            }
        });
    </script>
</body>
</html>
